name: Deploy to Coolify

on:
  push:
    branches: ["main"]

env:
  REGISTRY: ghcr.io

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      image_next: ${{ steps.tags.outputs.image_next }}
      image_flask: ${{ steps.tags.outputs.image_flask }}
    steps:
      - name: Set image tags
        id: tags
        run: |
          OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          REPO=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')
          echo "image_next=${{ env.REGISTRY }}/${OWNER}/${REPO}:latest" >> $GITHUB_OUTPUT
          echo "image_flask=${{ env.REGISTRY }}/${OWNER}/${REPO}-flask:latest" >> $GITHUB_OUTPUT

  build-nextjs:
    needs: prepare
    runs-on: ubuntu-latest
    environment: Production
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ needs.prepare.outputs.image_next }}
          cache-from: type=gha,scope=nextjs
          cache-to: type=gha,mode=max,scope=nextjs
          build-args: |
            FLASK_API_URL=${{ vars.FLASK_API_URL }}

  build-flask:
    needs: prepare
    runs-on: ubuntu-latest
    environment: Production
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.flask
          push: true
          tags: ${{ needs.prepare.outputs.image_flask }}
          cache-from: type=gha,scope=flask
          cache-to: type=gha,mode=max,scope=flask
          build-args: |
            ROBOFLOW_API_KEY=${{ secrets.ROBOFLOW_API_KEY }}

  deploy-flask:
    needs: build-flask
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Deploy and wait
        run: |
          RESPONSE=$(curl --fail --silent --request GET "${{ secrets.COOLIFY_WEBHOOK_FLASK }}" \
            --header "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}")

          DEPLOYMENT_UUID=$(echo "$RESPONSE" | jq -r '.deployments[0].deployment_uuid // .deployment_uuid // empty')

          if [ -z "$DEPLOYMENT_UUID" ]; then
            echo "::error::Failed to get deployment UUID"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "Deployment UUID: $DEPLOYMENT_UUID"

          COOLIFY_BASE=$(echo "${{ secrets.COOLIFY_WEBHOOK_FLASK }}" | sed 's|/api/v1/deploy.*||')

          echo "Coolify base: ${COOLIFY_BASE}"
          echo "Polling: ${COOLIFY_BASE}/api/v1/deployments/${DEPLOYMENT_UUID}"

          for i in $(seq 1 60); do
            HTTP_CODE=$(curl --silent --output /tmp/deploy_response.json --write-out "%{http_code}" \
              "${COOLIFY_BASE}/api/v1/deployments/${DEPLOYMENT_UUID}" \
              --header "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}")

            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "::warning::API returned HTTP $HTTP_CODE (attempt $i/60)"
              cat /tmp/deploy_response.json 2>/dev/null || true
              sleep 10
              continue
            fi

            STATUS=$(jq -r '.status // empty' /tmp/deploy_response.json)

            case "$STATUS" in
              "finished")
                echo "Flask deployment succeeded"
                exit 0
                ;;
              "failed"|"cancelled")
                echo "::error::Flask deployment ${STATUS}"
                jq . /tmp/deploy_response.json
                exit 1
                ;;
              *)
                echo "Status: ${STATUS:-unknown} (attempt $i/60)"
                sleep 10
                ;;
            esac
          done

          echo "::error::Flask deployment timed out"
          exit 1

  deploy-nextjs:
    needs: [build-nextjs, deploy-flask]
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Deploy and wait
        run: |
          RESPONSE=$(curl --fail --silent --request GET "${{ secrets.COOLIFY_WEBHOOK }}" \
            --header "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}")

          DEPLOYMENT_UUID=$(echo "$RESPONSE" | jq -r '.deployments[0].deployment_uuid // .deployment_uuid // empty')

          if [ -z "$DEPLOYMENT_UUID" ]; then
            echo "::error::Failed to get deployment UUID"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "Deployment UUID: $DEPLOYMENT_UUID"

          COOLIFY_BASE=$(echo "${{ secrets.COOLIFY_WEBHOOK }}" | sed 's|/api/v1/deploy.*||')

          echo "Coolify base: ${COOLIFY_BASE}"
          echo "Polling: ${COOLIFY_BASE}/api/v1/deployments/${DEPLOYMENT_UUID}"

          for i in $(seq 1 60); do
            HTTP_CODE=$(curl --silent --output /tmp/deploy_response.json --write-out "%{http_code}" \
              "${COOLIFY_BASE}/api/v1/deployments/${DEPLOYMENT_UUID}" \
              --header "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}")

            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "::warning::API returned HTTP $HTTP_CODE (attempt $i/60)"
              cat /tmp/deploy_response.json 2>/dev/null || true
              sleep 10
              continue
            fi

            STATUS=$(jq -r '.status // empty' /tmp/deploy_response.json)

            case "$STATUS" in
              "finished")
                echo "Next.js deployment succeeded"
                exit 0
                ;;
              "failed"|"cancelled")
                echo "::error::Next.js deployment ${STATUS}"
                jq . /tmp/deploy_response.json
                exit 1
                ;;
              *)
                echo "Status: ${STATUS:-unknown} (attempt $i/60)"
                sleep 10
                ;;
            esac
          done

          echo "::error::Next.js deployment timed out"
          exit 1

  summary:
    needs: [prepare, deploy-nextjs, deploy-flask]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Deployment" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Next.js | ${{ needs.prepare.outputs.image_next }} | ${{ needs.deploy-nextjs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Flask | ${{ needs.prepare.outputs.image_flask }} | ${{ needs.deploy-flask.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} | |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} | |" >> $GITHUB_STEP_SUMMARY
